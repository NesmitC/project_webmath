# app/neuro_kurator.py

from app.models import Result
from datetime import datetime



def generate_kurator_response(user_is_authenticated):
    if not user_is_authenticated:
        return {
            "answer": (
                "–ß—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å –≤–∞—à —É—Ä–æ–≤–µ–Ω—å –∏ –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏, "
                "—Ä–µ–∫–æ–º–µ–Ω–¥—É—é –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –ù–µ–π—Ä–æ—Å—Ç–∞—Ç–µ.<br><br>"
                "<a href='/register' class='kurator-link'>"
                "‚Üí –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è"
                "</a>"
            ),
            "role": "neuro_kurator"
        }

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –≤—ã–¥–∞—ë–º "—Ä–µ–∑—é–º–µ-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é"
    recommendation = (
        "–ù–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —É—á–∞—â–∏—Ö—Å—è, –≤–æ—Ç –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω:<br><br>"
        "<strong>‚úÖ –ß—Ç–æ –¥–µ–ª–∞—Ç—å:</strong><br>"
        "‚Ä¢ –ü—Ä–æ–π–¥–∏—Ç–µ –≤—Ö–æ–¥—è—â—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É ‚Äî –æ–Ω–∞ –ø–æ–∫–∞–∂–µ—Ç —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞<br>"
        "‚Ä¢ –£–¥–µ–ª–∏—Ç–µ 3 –¥–Ω—è —Ç–µ–º–∞–º: –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è, –ª–µ–∫—Å–∏—á–µ—Å–∫–∏–µ –Ω–æ—Ä–º—ã, —Å–∏–Ω—Ç–∞–∫—Å–∏—Å<br>"
        "‚Ä¢ –ü–∏—à–∏—Ç–µ –ø–æ 1 —Å–æ—á–∏–Ω–µ–Ω–∏—é –≤ 2 –¥–Ω—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π<br><br>"
        "<strong>üéØ –¶–µ–ª—å:</strong> –ü–æ–¥–Ω—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ 80+ –±–∞–ª–ª–æ–≤ –∑–∞ 4 –Ω–µ–¥–µ–ª–∏.<br><br>"
        "<a href='/diagnostic' class='kurator-link'>"
        "‚Üí –ü—Ä–æ–π—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É"
        "</a>"
    )

    return {
        "answer": recommendation,
        "role": "neuro_kurator"
    }



# –ü—Ä–∞–≤–∏–ª–∞: –∫–∞–∫–∏–µ –Ω–æ–º–µ—Ä–∞ –∑–∞–¥–∞–Ω–∏–π –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –∫–∞–∫–∏–º —Ç–µ–º–∞–º
THEME_MAP = {
    '—Å—Ç–∏–ª—å –∏ –ª–µ–∫—Å–∏–∫–∞ —Ç–µ–∫—Å—Ç–∞': [1, 2, 3],
    '–æ—Ä—Ñ–æ—ç–ø–∏—è': [4],
    '—Ä–µ—á–µ–≤–∞—è –Ω–æ—Ä–º–∞: –ø–∞—Ä–æ–Ω–∏–º—ã': [5],
    '—Ä–µ—á–µ–≤–∞—è –Ω–æ—Ä–º–∞: –ø–ª–µ–æ–Ω–∞–∑–º (–∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å) –∏ –ª–µ–∫—Å–∏—á–µ—Å–∫–∞—è —Å–æ—á–µ—Ç–∞–µ–º–æ—Å—Ç—å': [6],
    '–≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–æ—Ä–º—ã': [7, 8],
    '–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è': [9, 10, 11, 12, 13, 14, 15],
    '–ø—É–Ω–∫—Ç—É–∞—Ü–∏—è': [16, 17, 18, 19, 20, 21],
    '–≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞': [22],
    '—Å–º—ã—Å–ª —Ç–µ–∫—Å—Ç–∞': [23],
    '—Ç–∏–ø—ã —Ç–µ–∫—Å—Ç–∞': [24],
    '–ª–µ–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞': [25],
    '—Å–≤—è–∑—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π': [26],
    '—Å–æ—á–∏–Ω–µ–Ω–∏–µ': ['essay']
}

# –ü–æ—Ä–æ–≥ –¥–ª—è "—Å–ª–∞–±–æ–≥–æ –º–µ—Å—Ç–∞" ‚Äî —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –∑–∞ –∑–∞–¥–∞–Ω–∏–µ < 1.2
WEAK_THRESHOLD = 1.2


def analyze_student(user_id, db):
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—á–µ–Ω–∏–∫–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç"""
    results = Result.query.filter_by(user_id=user_id).order_by(Result.timestamp).all()

    if not results:
        return {"error": "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏"}

    # –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞–∂–¥–æ–º—É –∑–∞–¥–∞–Ω–∏—é
    scores = {i: [] for i in range(1, 27)}
    essay_scores = []
    test_dates = []

    for r in results:
        for i in range(1, 27):
            q_score = getattr(r, f'q{i}', 0)
            if q_score is not None:
                scores[i].append(q_score)
        if r.essay_score is not None:
            essay_scores.append(r.essay_score)
        test_dates.append(r.timestamp)

    # –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–∏–µ –±–∞–ª–ª—ã
    avg_scores = {i: sum(s) / len(s) for i, s in scores.items() if s}
    avg_essay = sum(essay_scores) / len(essay_scores) if essay_scores else 0

    # –ù–∞—Ö–æ–¥–∏–º —Å–ª–∞–±—ã–µ —Ç–µ–º—ã
    weak_themes = []
    for theme, questions in THEME_MAP.items():
        if theme == '—Å–æ—á–∏–Ω–µ–Ω–∏–µ':
            if avg_essay < 12:
                weak_themes.append('—Å–æ—á–∏–Ω–µ–Ω–∏–µ')
            continue

        theme_scores = [avg_scores[q] for q in questions if q in avg_scores]
        if theme_scores:
            avg = sum(theme_scores) / len(theme_scores)
            if avg < WEAK_THRESHOLD:
                weak_themes.append(theme)

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    test_types = [r.test_type for r in results]
    first_type = test_types[0] if test_types else '‚Äî'
    last_type = test_types[-1] if test_types else '‚Äî'

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    recommendations = generate_recommendations(weak_themes)

    return {
        'user_id': user_id,
        'total_tests': len(results),
        'first_test': test_dates[0] if test_dates else None,
        'last_test': test_dates[-1] if test_dates else None,
        'test_progress': f"{first_type} ‚Üí {last_type}",
        'avg_scores': avg_scores,
        'weak_themes': weak_themes,
        'strong_themes': [t for t in THEME_MAP.keys() if t not in weak_themes],
        'avg_essay': round(avg_essay, 1),
        'recommendations': recommendations,
        'has_improved': len(results) > 1  # –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å ‚Äî —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å first –∏ last score
    }


def generate_recommendations(weak_themes):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞)"""
    recs = []

    if '–æ—Ä—Ñ–æ—ç–ø–∏—è' in weak_themes:
        recs.append("–ü—Ä–æ–π–¥–∏ –º–æ–¥—É–ª—å ¬´–û—Ä—Ñ–æ—ç–ø–∏—è¬ª –∏ —Ä–µ—à–∏ 5 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤.")
    if '—Ä–µ—á–µ–≤–∞—è –Ω–æ—Ä–º–∞: –ø–∞—Ä–æ–Ω–∏–º—ã' in weak_themes:
        recs.append("–ü–æ–≤—Ç–æ—Ä–∏ –ø–∞—Ä–æ–Ω–∏–º—ã ‚Äî –≤—ã–ø–æ–ª–Ω–∏ 3 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ –º–æ–¥—É–ª—è ¬´–õ–µ–∫—Å–∏–∫–∞¬ª.")
    if '–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è' in weak_themes:
        recs.append("–ü–æ–≤—Ç–æ—Ä–∏ –∫–æ—Ä–Ω–∏ —Å —á–µ—Ä–µ–¥–æ–≤–∞–Ω–∏–µ–º –∏ –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∞–≤–æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–∏—Å—Ç–∞–≤–æ–∫ ‚Äî —Ä–µ—à–∏ 5 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.")
    if '–ø—É–Ω–∫—Ç—É–∞—Ü–∏—è' in weak_themes:
        recs.append("–ü–æ—Ç—Ä–µ–Ω–∏—Ä—É–π —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫—É –∑–∞–ø—è—Ç—ã—Ö –≤ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö ‚Äî –≤—ã–ø–æ–ª–Ω–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Å—Ç.")
    if '—Å–æ—á–∏–Ω–µ–Ω–∏–µ' in weak_themes:
        recs.append("–ù–∞–ø–∏—à–∏ —Å–æ—á–∏–Ω–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É ‚Äî —è –¥–∞–º –ø–æ–¥—Ä–æ–±–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º.")
    if '—Å—Ç–∏–ª—å –∏ –ª–µ–∫—Å–∏–∫–∞ —Ç–µ–∫—Å—Ç–∞' in weak_themes:
        recs.append("–ü–æ–≤—Ç–æ—Ä–∏ —Å—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏ –ª–µ–∫—Å–∏—á–µ—Å–∫—É—é —Å–æ—á–µ—Ç–∞–µ–º–æ—Å—Ç—å ‚Äî –ø–æ—Å–º–æ—Ç—Ä–∏ –≤–∏–¥–µ–æ –∏ –ø—Ä–æ–π–¥–∏ –≤–∏–∫—Ç–æ—Ä–∏–Ω—É.")
    if not recs:
        recs.append("–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –£ —Ç–µ–±—è –Ω–µ—Ç —Å–ª–∞–±—ã—Ö —Ç–µ–º. –•–æ—á–µ—à—å –ø—Ä–æ–π—Ç–∏ –ø—Ä–æ–±–Ω—ã–π —ç–∫–∑–∞–º–µ–Ω?")

    return recs